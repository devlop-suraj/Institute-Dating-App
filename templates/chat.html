{% extends "base.html" %}

{% block title %}Chat with {{ other_user.first_name }} - Institute Dating{% endblock %}

{% block content %}
<style>
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-typing {
    animation: slideIn 0.3s ease-out;
}

.chat-message {
    animation: slideIn 0.3s ease-out;
}

#typingIndicator {
    transition: opacity 0.3s ease;
}

.card-header {
    transition: all 0.3s ease;
}

.btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}
</style>

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <div class="bg-white bg-opacity-20 rounded-circle p-2 me-3">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">{{ other_user.first_name }} {{ other_user.last_name }}</h5>
                        <small>{{ other_user.institute }} - {{ other_user.course }}</small>
                    </div>
                    <a href="{{ url_for('profile', user_id=other_user.id) }}" class="btn btn-outline-light btn-sm ms-auto">
                        <i class="fas fa-eye"></i> View Profile
                    </a>
                </div>
            </div>
            
            <div class="card-body" style="height: 400px; overflow-y: auto;" id="chatMessages">
                {% if messages %}
                    {% for message in messages %}
                        <div class="mb-3 chat-message {% if message.sender_id == current_user.id %}text-end{% endif %}">
                            <div class="d-inline-block">
                                <div class="{% if message.sender_id == current_user.id %}bg-primary text-white{% else %}bg-light{% endif %} rounded-3 px-3 py-2">
                                    <p class="mb-1">{{ message.content }}</p>
                                    <small class="{% if message.sender_id == current_user.id %}text-white-50{% else %}text-muted{% endif %}">
                                        {{ message.timestamp.strftime('%H:%M') }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted mt-5">
                        <i class="fas fa-comments" style="font-size: 3rem;"></i>
                        <p class="mt-3">No messages yet. Start the conversation!</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="card-footer">
                <form id="messageForm" class="d-flex gap-2">
                    <input type="hidden" id="receiverId" value="{{ other_user.id }}">
                    <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." required>
                    <button type="submit" class="btn btn-primary" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                <div id="typingIndicator" class="text-muted small mt-2" style="display: none;">
                    <i class="fas fa-circle text-primary"></i> {{ other_user.first_name }} is typing...
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <div class="d-flex justify-content-center gap-2">
                <a href="{{ url_for('profile', user_id=other_user.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-user me-2"></i>View Profile
                </a>
                <a href="{{ url_for('matches') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Matches
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let lastMessageCount = 0;
let isPolling = true;

// Auto-scroll to bottom of chat
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Scroll to bottom on page load
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    lastMessageCount = document.querySelectorAll('#chatMessages .mb-3').length;
    startMessagePolling();
});

// Start polling for new messages
function startMessagePolling() {
    setInterval(function() {
        if (isPolling) {
            fetchNewMessages();
        }
    }, 3000); // Check every 3 seconds
}

// Fetch new messages from server
function fetchNewMessages() {
    const receiverId = document.getElementById('receiverId').value;
    
    fetch(`/get_messages/${receiverId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateChatMessages(data.messages);
            }
        })
        .catch(error => {
            console.error('Error fetching messages:', error);
        });
}

// Update chat messages
function updateChatMessages(messages) {
    const chatMessages = document.getElementById('chatMessages');
    const currentMessageCount = chatMessages.querySelectorAll('.mb-3').length;
    
    // Only update if there are new messages
    if (messages.length > currentMessageCount) {
        // Check if we need to scroll (only if user is at bottom)
        const isAtBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 10;
        
        // Clear existing messages
        chatMessages.innerHTML = '';
        
        // Add all messages
        messages.forEach(msg => {
            const isOwn = msg.sender_id === '{{ current_user.id }}';
            addMessageToChat(msg.content, msg.timestamp, isOwn, false);
        });
        
        // Only auto-scroll if user was at bottom or if it's a new message from other user
        if (isAtBottom || messages[messages.length - 1].sender_id !== '{{ current_user.id }}') {
            scrollToBottom();
        }
        
        lastMessageCount = messages.length;
        
        // Show notification for new messages from other user
        if (messages.length > currentMessageCount && messages[messages.length - 1].sender_id !== '{{ current_user.id }}') {
            showNewMessageNotification();
        }
    }
}

// Show notification for new messages
function showNewMessageNotification() {
    // Check if browser supports notifications
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('New Message', {
            body: '{{ other_user.first_name }} sent you a message',
            icon: '/static/favicon.ico'
        });
    }
    
    // Also show a subtle visual indicator
    const chatHeader = document.querySelector('.card-header');
    chatHeader.style.animation = 'pulse 0.5s ease-in-out';
    setTimeout(() => {
        chatHeader.style.animation = '';
    }, 500);
}

// Request notification permission on page load
document.addEventListener('DOMContentLoaded', function() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});

// Handle message form submission
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const receiverId = document.getElementById('receiverId').value;
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Disable send button and show loading state
    const sendButton = document.getElementById('sendButton');
    const originalText = sendButton.innerHTML;
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Send message via AJAX
    fetch('/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `receiver_id=${receiverId}&content=${encodeURIComponent(message)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add message to chat
            addMessageToChat(message, data.timestamp, true, true);
            messageInput.value = '';
            scrollToBottom();
            
            // Fetch updated messages to ensure sync
            setTimeout(fetchNewMessages, 500);
        } else {
            alert('Error sending message: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the message.');
    })
    .finally(() => {
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.innerHTML = originalText;
    });
});

// Add typing indicator functionality
let typingTimer;
const messageInput = document.getElementById('messageInput');

messageInput.addEventListener('input', function() {
    clearTimeout(typingTimer);
    
    // Show typing indicator
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.style.display = 'block';
    
    // Hide typing indicator after 2 seconds of no typing
    typingTimer = setTimeout(function() {
        typingIndicator.style.display = 'none';
    }, 2000);
});

// Add message to chat with smooth animation
function addMessageToChat(content, timestamp, isOwn, shouldScroll = true) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 chat-message ${isOwn ? 'text-end' : ''}`;
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateY(20px)';
    messageDiv.style.transition = 'all 0.3s ease';
    
    // Handle both string timestamps and Date objects
    let timeString;
    if (typeof timestamp === 'string') {
        timeString = timestamp;
    } else {
        timeString = timestamp.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
    
    messageDiv.innerHTML = `
        <div class="d-inline-block">
            <div class="${isOwn ? 'bg-primary text-white' : 'bg-light'} rounded-3 px-3 py-2">
                <p class="mb-1">${content}</p>
                <small class="${isOwn ? 'text-white-50' : 'text-muted'}">${timeString}</small>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // Animate the message in
    setTimeout(() => {
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
    }, 50);
    
    if (shouldScroll) {
        scrollToBottom();
    }
}

// Stop polling when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        isPolling = false;
    } else {
        isPolling = true;
    }
});

// Stop polling when leaving the page
window.addEventListener('beforeunload', function() {
    isPolling = false;
});
</script>
{% endblock %}
